<html>
<title>Test Interno SITO CGT LOGIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<h1> Sito CGT!</h1>

<div class="flex-center full-height">
    <div class="content">
        <div id="buttonLogin">
            <button type="button" onclick='initiateSSOFlow()'>Login!</button>
        </div>
        <div id="userOk" class="hidden">
            <h2>Benvenuto</h2>
            <div id="loginOk" class="code"></div>
            <button type="button" onclick='logoutUser()'>LOGOUT</button>
        </div>
    </div>
</div>  

<script>

//////////////////////////////////////////////////////////////////////
//-- RENDER --//

queryString = window.location.search;
console.log('acess token after refresh' +localStorage.getItem("accToken"));
urlParams = new URLSearchParams(queryString);
// Controllo se Ã¨ presente un access token
if(localStorage.getItem("accToken") !== null && urlParams.get('code') !== null){
    getUserInfo(localStorage.getItem("accToken"), localStorage.getItem("commUrl"));
}else if(urlParams.get('code') !== null){
    console.log(queryString);
    console.log('Loading Callback Params: ' + urlParams);
    //Create the Code Response from the URL params
    codeResponse = new Object;
    codeResponse.code = urlParams.get('code');
    codeResponse.state = urlParams.get('state');
    codeResponse.sfdc_community_url = urlParams.get('sfdc_community_url');
// Call the common token exhcange method.
    //tokenExchange(codeResponse, localStorage.getItem("pkce_code_verifier"), localStorage.getItem("clientId"), 'code', null);
}
    
async function initiateSSOFlow() {
//-- Costanti & Variabili --//
    const commUrl = 'https://cgtspa--devmerge.sandbox.my.site.com/CGTPortaleRegistrazioneClienti';
    const authorizeURI = '/services/oauth2/authorize';
    const clientId = '3MVG9bmlmX4LX1ZvlQPwDwh5N1fOBV4wLtXixm2uPy7urVdUASmTjYk.YlQ65RUOIlT8k8OVhqIRROaa2B9yf';
    localStorage.setItem("clientId", clientId);
    localStorage.setItem("sorgente", "sitoCGT");
    localStorage.setItem("commUrl", commUrl);
    const redirectURI = 'https://cridolby.github.io/Seconda/'
    const responsType = 'code';
    const ssoProvider = 'AzureADB2CTest';

//-- PCKE Generator --//

    const codeVerifier = generateRandomString();
    localStorage.setItem("pkce_code_verifier", codeVerifier);
    console.log('codeVerifier: '+codeVerifier );
        // Hash and base64-urlencode the secret to use as the challenge
    const codeChallenge = await pkceChallengeFromVerifier(codeVerifier);
    console.log('codeChallenge: '+codeChallenge );

//-- Costruzione redirect --//
    redirectURL = commUrl + authorizeURI +
     '?client_id=' + clientId + 
     '&prompt=login%20consent' +
     '&redirect_uri=' + redirectURI + 
     '&response_type=' + responsType +
     '&sso_provider=' + ssoProvider + 
     '&code_challenge=' + encodeURIComponent(codeChallenge) + 
     '&code_verifier=' + encodeURIComponent(codeVerifier);

//-- Redirect the Browser --//
    window.location = redirectURL;
}

    
function parseQueryString(string) {
    if(string == "") { return {}; }
    var segments = string.split("&").map(s => s.split("=") );
    var queryString = {};
    segments.forEach(s => queryString[s[0]] = s[1]);
    return queryString;
}

function generateRandomString() {
    var array = new Uint32Array(28);
    window.crypto.getRandomValues(array);
    return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
}

// Calculate the SHA256 hash of the input text. 
// Returns a promise that resolves to an ArrayBuffer
function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    return window.crypto.subtle.digest('SHA-256', data);
}

// Base64-urlencodes the input string
function base64urlencode(str) {
    // Convert the ArrayBuffer to string using Uint8 array to conver to what btoa accepts.
    // btoa accepts chars only within ascii 0-255 and base64 encodes them.
    // Then convert the base64 encoded to base64url encoded
    //   (replace + with -, replace / with _, trim trailing =)
    return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// Return the base64-urlencoded sha256 hash for the PKCE challenge
async function pkceChallengeFromVerifier(v) {
    hashed = await sha256(v);
    return base64urlencode(hashed);
}

    

</script>
<style>
body {
  padding: 0;
  margin: 0;
  min-height: 100vh;
  font-family: arial, sans-serif;
}
@media(max-width: 400px) {
  body {
    padding: 10px;
  }
}
.full-height {
  min-height: 100vh;
}
.flex-center {
  align-items: center;
  display: flex;
  justify-content: center;
}
.content {
  max-width: 400px;
}
h2 {
  text-align: center;
}
.code {
  font-family: "Courier New", "Courier", monospace;
  width: 100%;
  padding: 4px;
  border: 1px #ccc solid;
  border-radius: 4px;
  word-break: break-all;
}
.hidden {
  display: none;
}
</style>

</html>
